
# TCP 协议

## connection refuse 在 tcpdump 抓包会有什么表现

在使用 `tcpdump` 抓包分析网络问题时，如果遇到 "connection refused" 的情况，通常意味着你尝试连接的服务没有在目标端口上监听，或者目标主机的防火墙配置拒绝了你的连接请求。在 TCP 层面上，这种情况会表现为一个 TCP 三次握手失败的过程，具体来说，你会看到以下的 TCP 包交换序列：

1. **SYN**：客户端发送一个 SYN 包到服务器，请求建立连接。
2. **RST, ACK**：服务器回应一个 RST (重置) 包加上 ACK 标志，这表示没有进程在监听目标端口，因此连接不能建立。

### wireshark 中的表现

红色的 RST 包

<img width="468" alt="image" src="https://github.com/Mr-YYM/knowledge/assets/31896405/76a048e1-f0bb-4ff2-ace6-97ee3077be18">


### 示例

假设客户端 IP 是 `192.168.1.100`，服务器 IP 是 `192.168.1.101`，客户端尝试连接服务器的 80 端口。如果服务没有在运行或被拒绝连接，使用 `tcpdump` 的输出可能如下所示：

```
192.168.1.100.12345 > 192.168.1.101.80: Flags [S], ...
192.168.1.101.80 > 192.168.1.100.12345: Flags [R.], ...
```

- 第一行表示客户端（192.168.1.100）的端口 12345 发送了一个 SYN 包到服务器（192.168.1.101）的 80 端口，尝试开始 TCP 握手。
- 第二行表示服务器响应了一个带有 RST 和 ACK 标志的包，这意味着连接被拒绝。

### 解读 `tcpdump` 输出

在 `tcpdump` 输出中，你可以通过包的 Flags 来识别这些包：

- **S** 标志代表 SYN，表示开始一个新的连接。
- **R** 标志代表 RST，表示重置连接。
- **.`** 表示 ACK，用于确认收到包。

### 注意

- 如果你没有看到期望的 SYN 或 RST, ACK 包，可能需要检查你的 `tcpdump` 过滤条件，确保没有过滤掉这些交换包。
- "connection refused" 错误通常是由于目标端口没有应用程序监听导致的。检查目标系统上的服务是否运行，以及防火墙和安全组设置是否允许该连接。

通过 `tcpdump` 和理解 TCP 包的标志，你可以深入分析并理解网络连接问题的原因。


