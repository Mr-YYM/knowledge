# VPN

## IPsec VPN

为了理解 IPsec VPN 是如何处理 IP 数据包的，我们可以通过一个简单的示例来展示数据包在进入和离开 IPsec 隧道时的变化。

### 示例情景
假设有两个网络通过 IPsec VPN 连接，网络 A 和网络 B。网络 A 中的一台主机发送一个 IP 数据包给网络 B 中的主机。

#### 原始 IP 数据包（处理前）
原始 IP 数据包可能如下所示：

- **源 IP 地址**: 192.168.1.10（来自网络 A 的主机）
- **目的 IP 地址**: 192.168.2.10（目标是网络 B 的主机）
- **数据**: “Hello, IPsec!”

```
[IP Header]
Source IP: 192.168.1.10
Destination IP: 192.168.2.10
[Payload]
Data: "Hello, IPsec!"
```

#### 处理后的 IPsec 数据包
当这个数据包通过 IPsec VPN 处理后，会根据使用的 IPsec 模式（通常是隧道模式或传输模式）进行封装和加密。我们这里使用隧道模式作为示例，这是 IPsec VPN 中最常用的模式。

**隧道模式**将整个原始 IP 数据包封装在新的 IP 数据包中，并对其进行加密和认证。

- **源 IP 地址**: 10.0.0.1（网络 A 的网关或VPN端点的IP）
- **目的 IP 地址**: 10.0.0.2（网络 B 的网关或VPN端点的IP）
- **封装的 IPsec 数据**: 加密后的原始数据包

处理后的 IPsec 数据包可能如下所示：

```
[New IP Header]               <--- 这是隧道模式下的新IP头
Source IP: 10.0.0.1
Destination IP: 10.0.0.2
[IPsec Header]                <--- IPsec 特定的封装和认证信息
[Encrypted Payload]
[Original IP Header]          <--- 原始IP数据包，现在是加密的部分
Source IP: 192.168.1.10
Destination IP: 192.168.2.10
[Payload]
Data: "Hello, IPsec!"
```

#### 详细的处理步骤

1. **封装（Encapsulation）**:
   - 原始 IP 数据包被整个封装在一个新的 IP 数据包中。
   - 新的 IP 头的源 IP 地址是网络 A 的 VPN 端点（10.0.0.1），目的 IP 地址是网络 B 的 VPN 端点（10.0.0.2）。

2. **加密（Encryption）**:
   - 原始 IP 数据包（包括头部和负载）被加密。
   - 加密后的数据包形成了 IPsec 数据负载。

3. **认证（Authentication）**:
   - IPsec 数据包还会包括一个认证头（AH 或 ESP 头），用于确保数据包在传输过程中没有被篡改。

#### 处理后数据包的传输过程
加密和封装后的数据包通过公共网络传输到网络 B 的 VPN 端点，网络 B 的 VPN 端点接收到数据包后，会执行以下操作：

1. **解密（Decryption）**：对数据包进行解密，恢复出原始的 IP 数据包。
2. **解封装（Decapsulation）**：移除封装的 IPsec 头和新的 IP 头，得到原始 IP 数据包。
3. **转发（Forwarding）**：将原始 IP 数据包发送给目的主机（192.168.2.10）。

#### 总结
通过 IPsec 隧道模式，原始 IP 数据包被加密和封装，以确保数据在公共网络上的传输安全性。这样，即使数据包被截获，攻击者也无法读取数据的内容或篡改数据。

## IPsec VPN 概念

在 IPsec VPN 中，预共享密钥（Pre-Shared Key，PSK）、IKE（Internet Key Exchange）、阶段1（Phase 1）和阶段2（Phase 2）是涉及 VPN 连接建立和管理的关键概念。下面是对这些术语的详细解释：

### 1. 预共享密钥（Pre-Shared Key, PSK）
预共享密钥是一种认证方式，它在双方之间预先共享的一个秘密值（即密钥），用来在建立 VPN 连接时验证对方的身份。PSK 是在配置 VPN 时手动设置的，并在双方设备上保持一致。它是一种对称加密密钥，意味着在通信双方使用相同的密钥来进行身份验证。

### 2. IKE（Internet Key Exchange）
IKE 是一种协议，用于建立和管理 IPsec 安全关联（Security Association, SA）。IKE 的主要功能是协商、建立和维护安全策略以及动态地交换密钥。IKE 协议通常分为两个阶段来完成这些任务。

### 3. 阶段1（Phase 1）
阶段1 是 IKE 协商的第一个步骤，目标是建立一个安全的、加密的通道，称为 IKE SA，用于保护后续的 IKE 消息。这一阶段主要包括以下过程：

- **身份验证**：双方使用预共享密钥（PSK）、数字证书或公钥加密来验证对方的身份。
- **协商加密和哈希算法**：双方协商将用于保护 IKE 消息的加密算法（如 AES）和哈希算法（如 SHA）。
- **DH 密钥交换**：双方使用 Diffie-Hellman (DH) 算法生成一个共享的秘密密钥，进一步保护 IKE 消息。

阶段1 有两种模式：
- **主模式（Main Mode）**：使用六个消息交换来逐步建立安全的 IKE SA，强调安全性。
- **野蛮模式（Aggressive Mode）**：使用三个消息快速建立 IKE SA，但牺牲了一部分安全性。

成功完成阶段1 后，双方之间建立了一个 IKE SA，所有后续的 IKE 消息都通过这个加密通道进行保护。

### 4. 阶段2（Phase 2）
阶段2 的目标是基于阶段1中建立的安全通道协商具体的 IPsec SA，用于实际的数据加密和传输。阶段2 主要包括以下过程：

- **协商 IPsec 安全协议和算法**：双方协商用于保护数据流量的 IPsec 协议（如 ESP）和具体的加密、哈希算法。
- **创建 IPsec SA**：根据协商的内容，建立一个或多个 IPsec SA，分别用于保护通信的不同部分。
- **生成会话密钥**：基于阶段1生成的共享密钥，生成新的密钥，用于加密和解密 IPsec 数据包。

在阶段2 完成后，实际的用户数据可以通过 IPsec SA 进行加密传输。

### 简单示例
设想你有两个站点 A 和 B，它们需要通过 IPsec VPN 进行安全通信。

- **预共享密钥（PSK）**：在配置时，站点 A 和 B 共享了一个预共享密钥 "VPNSecret123"。
- **阶段1**：站点 A 和 B 使用 PSK 验证对方的身份，并协商使用 AES 作为加密算法，使用 SHA-256 作为哈希算法，生成了一个共享的 DH 秘密密钥。这一阶段建立了一个安全的 IKE SA。
- **阶段2**：在这个安全的通道上，站点 A 和 B 协商了使用 ESP 作为 IPsec 协议，继续使用 AES 进行数据加密，生成新的会话密钥，并创建了用于实际数据传输的 IPsec SA。

成功完成这两个阶段后，站点 A 和 B 就可以通过加密的 IPsec SA 安全地传输数据。

### 总结
- **预共享密钥（PSK）** 是一种简单的身份验证方法。
- **IKE** 是用于管理 IPsec SA 的协议。
- **阶段1** 负责建立安全的 IKE SA，用于保护后续的通信。
- **阶段2** 负责协商和建立 IPsec SA，用于保护实际的数据传输。

这些步骤确保了 VPN 连接的安全性和数据的保密性。

